<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GrouchoBarks Game</title>
  <script src="https://sdk.scdn.co/spotify-player.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #000;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    
    #game {
      width: 100vw;
      height: calc(100vh - 60px);
    }
    
    #music-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: linear-gradient(90deg, #1db954, #1ed760);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    
    .player-section {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .music-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .music-btn:hover {
      background: rgba(255,255,255,0.4);
      transform: scale(1.1);
    }
    
    .music-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .track-info {
      color: white;
      font-size: 14px;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    
    .user-info {
      color: white;
      font-size: 12px;
      opacity: 0.8;
    }
    
    .status {
      color: white;
      font-size: 11px;
      opacity: 0.7;
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .hidden {
      display: none;
    }
    
    /* Mobile Controls */
    #mobile-controls {
      position: fixed;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      z-index: 1000;
    }
    
    @media (max-width: 768px), (pointer: coarse) {
      #mobile-controls {
        display: flex;
        gap: 15px;
        align-items: center;
      }
    }
    
    .mobile-btn {
      width: 60px;
      height: 60px;
      background: rgba(255,255,255,0.2);
      border: 2px solid rgba(255,255,255,0.4);
      border-radius: 15px;
      color: white;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      touch-action: manipulation;
      backdrop-filter: blur(10px);
      cursor: pointer;
    }
    
    .mobile-btn:active {
      background: rgba(255,255,255,0.4);
      transform: scale(0.95);
    }
    
    /* Compact login overlay */
    #login-overlay {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      z-index: 2000;
      color: white;
    }
    
    #login-overlay button {
      background: #1db954;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px;
    }
    
    #login-overlay button:hover {
      background: #1ed760;
    }
  </style>
</head>
<body>
  <!-- Game Container -->
  <div id="game"></div>
  
  <!-- Compact Login Overlay -->
  <div id="login-overlay">
    <h2>üéµ Add Music?</h2>
    <button id="login-btn">üéµ Login</button>
    <button id="skip-btn">üéÆ Skip</button>
  </div>
  
  <!-- Compact Music Bar -->
  <div id="music-bar" class="hidden">
    <!-- Left: Controls -->
    <div class="player-section">
      <button id="play-btn" class="music-btn" disabled title="Play">‚ñ∂Ô∏è</button>
      <button id="pause-btn" class="music-btn hidden" title="Pause">‚è∏Ô∏è</button>
      <button id="resume-btn" class="music-btn hidden" title="Resume">‚ñ∂Ô∏è</button>
      <button id="volume-btn" class="music-btn" title="Volume Test">üîä</button>
    </div>
    
    <!-- Center: Track Info -->
    <div class="track-info" id="track-info">
      Fratty Pipeline üéµ
    </div>
    
    <!-- Right: User & Status -->
    <div class="player-section">
      <div class="user-info" id="user-info">üéß <span id="user-name">--</span></div>
      <div class="user-info" style="font-size: 14px; font-weight: bold; color: #1db954;">v7</div>
      <button id="logout-btn" class="music-btn" title="Logout">üö™</button>
    </div>
  </div>
  
  <!-- Status (floating) -->
  <div id="status" class="status" style="position: fixed; top: 10px; right: 10px; z-index: 1001;"></div>

  <!-- Mobile Controls -->
  <div id="mobile-controls">
    <button class="mobile-btn" id="mobile-left">‚Üê</button>
    <button class="mobile-btn" id="mobile-up">‚Üë</button>
    <button class="mobile-btn" id="mobile-right">‚Üí</button>
    <button class="mobile-btn" id="mobile-down">‚Üì</button>
  </div>

  <script src="js/game.js?v=8"></script>
  <script>
    // Define updateStatus early
    function updateStatus(message, isError = false) {
      const statusDiv = document.getElementById('status');
      if (statusDiv) {
        statusDiv.textContent = message;
        statusDiv.style.color = isError ? '#ff6b6b' : '#1db954';
        console.log(message);
        setTimeout(() => { statusDiv.textContent = ''; }, 3000);
      }
    }
    
    // Check if game.js loaded properly
    if (typeof GameScene === 'undefined') {
      console.error('GameScene not loaded from game.js - file may have syntax error');
      updateStatus('‚ùå Game failed to load', true);
    }
    
    // Fallback GameConfig if not defined
    if (typeof GameConfig === 'undefined') {
      console.warn('GameConfig not loaded from game.js, using fallback');
      window.GameConfig = {
        type: Phaser.AUTO,
        parent: 'game',
        width: 11 * 48,
        height: 800,
        backgroundColor: 0x363e48,
        physics: { default: 'arcade' },
        scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH },
        render: { pixelArt: true, antialias: false, roundPixels: true },
        scene: GameScene
      };
    }
    // Spotify credentials
    const CLIENT_ID = 'aa16f7f72c04485fb93d86d2f7ee33d1';
    const REDIRECT_URI = 'https://frattypipeline.grouchobarks.bandmusicgames.party';
    const SCOPES = 'user-read-private user-read-email user-modify-playback-state user-read-playback-state streaming';
    const TEST_TRACK_URI = 'spotify:track:33lVSu93J91BDmhfRT7iTA';
    
    let accessToken = null;
    let spotifyPlayer = null;
    let deviceId = null;
    let game = null;
    
    // UI Elements
    const loginOverlay = document.getElementById('login-overlay');
    const musicBar = document.getElementById('music-bar');
    const statusDiv = document.getElementById('status');
    const loginBtn = document.getElementById('login-btn');
    const skipBtn = document.getElementById('skip-btn');
    const playBtn = document.getElementById('play-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const resumeBtn = document.getElementById('resume-btn');
    const volumeBtn = document.getElementById('volume-btn');
    const logoutBtn = document.getElementById('logout-btn');
    
    // updateStatus already defined above
    
    function generateRandomString(length) {
      const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      const values = crypto.getRandomValues(new Uint8Array(length));
      return values.reduce((acc, x) => acc + possible[x % possible.length], "");
    }
    
    async function sha256(plain) {
      const encoder = new TextEncoder();
      const data = encoder.encode(plain);
      return window.crypto.subtle.digest('SHA-256', data);
    }
    
    function base64encode(input) {
      return btoa(String.fromCharCode(...new Uint8Array(input)))
        .replace(/=/g, '')
        .replace(/\+/g, '-')
        .replace(/\//g, '_');
    }
    
    async function loginWithSpotify() {
      updateStatus('üéµ Starting login...');
      
      const codeVerifier = generateRandomString(64);
      const hashed = await sha256(codeVerifier);
      const codeChallenge = base64encode(hashed);
      
      localStorage.setItem('code_verifier', codeVerifier);
      
      const authUrl = new URL('https://accounts.spotify.com/authorize');
      authUrl.searchParams.append('response_type', 'code');
      authUrl.searchParams.append('client_id', CLIENT_ID);
      authUrl.searchParams.append('scope', SCOPES);
      authUrl.searchParams.append('redirect_uri', REDIRECT_URI);
      authUrl.searchParams.append('code_challenge_method', 'S256');
      authUrl.searchParams.append('code_challenge', codeChallenge);
      
      window.location.href = authUrl.toString();
    }
    
    async function handleCallback() {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      const error = urlParams.get('error');
      
      if (error) {
        updateStatus(`‚ùå ${error}`, true);
        startGame();
        return;
      }
      
      if (code) {
        updateStatus('üîë Getting token...');
        await exchangeCodeForToken(code);
      }
    }
    
    async function exchangeCodeForToken(code) {
      const codeVerifier = localStorage.getItem('code_verifier');
      
      try {
        const response = await fetch('https://accounts.spotify.com/api/token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({
            grant_type: 'authorization_code',
            code: code,
            redirect_uri: REDIRECT_URI,
            client_id: CLIENT_ID,
            code_verifier: codeVerifier
          })
        });
        
        if (!response.ok) throw new Error(`Token failed: ${response.status}`);
        
        const data = await response.json();
        accessToken = data.access_token;
        
        sessionStorage.setItem('spotify_access_token', accessToken);
        localStorage.removeItem('code_verifier');
        window.history.replaceState({}, document.title, window.location.pathname);
        
        updateStatus('‚úÖ Token OK');
        await getUserInfo();
        
      } catch (error) {
        updateStatus(`‚ùå ${error.message}`, true);
        startGame();
      }
    }
    
    async function getUserInfo() {
      try {
        const response = await fetch('https://api.spotify.com/v1/me', {
          headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        
        if (!response.ok) throw new Error(`User info failed: ${response.status}`);
        
        const user = await response.json();
        document.getElementById('user-name').textContent = user.display_name || 'User';
        
        if (user.product === 'premium') {
          updateStatus('üéµ Initializing...');
          loginOverlay.classList.add('hidden');
          musicBar.classList.remove('hidden');
          initializeSpotifyPlayer();
          startGame();
        } else {
          updateStatus('‚ö†Ô∏è Premium required', true);
          startGame();
        }
        
      } catch (error) {
        updateStatus(`‚ùå ${error.message}`, true);
        startGame();
      }
    }
    
    function initializeSpotifyPlayer() {
      if (!window.Spotify?.Player) {
        updateStatus('‚è≥ SDK loading...', true);
        return;
      }
      
      spotifyPlayer = new Spotify.Player({
        name: 'GrouchoBarks Player',
        getOAuthToken: cb => cb(accessToken),
        volume: 0.8
      });
      
      spotifyPlayer.addListener('initialization_error', ({ message }) => 
        updateStatus(`‚ùå Init: ${message}`, true));
      spotifyPlayer.addListener('authentication_error', ({ message }) => 
        updateStatus(`‚ùå Auth: ${message}`, true));
      spotifyPlayer.addListener('account_error', ({ message }) => 
        updateStatus(`‚ùå Account: ${message}`, true));
      spotifyPlayer.addListener('playback_error', ({ message }) => 
        updateStatus(`‚ùå Playback: ${message}`, true));
      
      spotifyPlayer.addListener('ready', ({ device_id }) => {
        updateStatus('üéµ Ready!');
        deviceId = device_id;
        playBtn.disabled = false;
        
        // Set initial volume
        spotifyPlayer.setVolume(0.8).then(() => {
          updateStatus('üîä Volume set');
        });
      });
      
      spotifyPlayer.addListener('player_state_changed', state => {
        if (!state) return;
        const isPlaying = !state.paused;
        
        playBtn.classList.toggle('hidden', isPlaying);
        pauseBtn.classList.toggle('hidden', !isPlaying);
        resumeBtn.classList.add('hidden');
        
        // Debug audio state
        if (state.track_window.current_track) {
          const track = state.track_window.current_track;
          updateStatus(`üéµ ${isPlaying ? 'Playing' : 'Paused'}: ${track.name}`);
        }
      });
      
      spotifyPlayer.connect();
    }
    
    async function playTestTrack() {
      if (!deviceId) {
        updateStatus('‚ùå Player not ready', true);
        return;
      }
      
      try {
        updateStatus('üéµ Starting...');
        
        // First, transfer playback to this device
        await fetch('https://api.spotify.com/v1/me/player', {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            device_ids: [deviceId],
            play: false
          })
        });
        
        // Wait a moment for transfer
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // Now play the track
        const response = await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ uris: [TEST_TRACK_URI] })
        });
        
        if (response.ok) {
          updateStatus('üéµ Playing!');
        } else {
          const errorText = await response.text();
          updateStatus(`‚ùå Play failed: ${response.status} - ${errorText}`, true);
        }
        
      } catch (error) {
        updateStatus(`‚ùå ${error.message}`, true);
      }
    }
    
    async function pauseTrack() {
      if (spotifyPlayer) {
        await spotifyPlayer.pause();
        updateStatus('‚è∏Ô∏è Paused');
        pauseBtn.classList.add('hidden');
        resumeBtn.classList.remove('hidden');
      }
    }
    
    async function resumeTrack() {
      if (spotifyPlayer) {
        await spotifyPlayer.resume();
        updateStatus('‚ñ∂Ô∏è Resumed');
        resumeBtn.classList.add('hidden');
        pauseBtn.classList.remove('hidden');
      }
    }
    
    async function testVolume() {
      if (!spotifyPlayer) {
        updateStatus('‚ùå Player not ready', true);
        return;
      }
      
      try {
        // Get current volume
        const volume = await spotifyPlayer.getVolume();
        updateStatus(`üîä Volume: ${Math.round(volume * 100)}%`);
        
        // Try to set volume to max for mobile
        await spotifyPlayer.setVolume(1.0);
        updateStatus('üîä Volume set to 100%');
        
        // Check if we need user interaction for audio on mobile
        if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
          updateStatus('üì± Mobile: Tap play after this!');
        }
        
      } catch (error) {
        updateStatus(`‚ùå Volume error: ${error.message}`, true);
      }
    }
    
    function logout() {
      accessToken = null;
      sessionStorage.removeItem('spotify_access_token');
      
      if (spotifyPlayer) {
        spotifyPlayer.disconnect();
        spotifyPlayer = null;
      }
      
      musicBar.classList.add('hidden');
      loginOverlay.classList.remove('hidden');
      updateStatus('üëã Logged out');
    }
    
    function startGame() {
      loginOverlay.classList.add('hidden');
      
      if (!game) {
        game = new Phaser.Game(GameConfig);
        
        // Pass Spotify player to game if available
        if (spotifyPlayer) {
          game.events.once('ready', () => {
            const gameScene = game.scene.getScene('GameScene');
            if (gameScene) {
              gameScene.setSpotifyPlayer({ 
                adjustVolumeForGameEvent: (type, intensity) => {
                  // Simple volume adjustment for game events
                  console.log(`üéµ Game event: ${type} (${intensity})`);
                }
              });
            }
          });
        }
      }
    }
    
    // Mobile controls
    let mobileKeys = {
      left: false, right: false, up: false, down: false
    };

    function simulateKeyPress(key, pressed) {
      // Get the game scene and simulate key input
      if (game && game.scene.getScene('GameScene')) {
        const gameScene = game.scene.getScene('GameScene');
        if (gameScene.cursors) {
          gameScene.cursors[key].isDown = pressed;
        }
      }
    }

    // Mobile control event listeners
    const mobileLeft = document.getElementById('mobile-left');
    const mobileUp = document.getElementById('mobile-up');
    const mobileRight = document.getElementById('mobile-right');
    const mobileDown = document.getElementById('mobile-down');

    // Touch/mouse events for mobile controls
    ['touchstart', 'mousedown'].forEach(eventType => {
      mobileLeft.addEventListener(eventType, (e) => {
        e.preventDefault();
        simulateKeyPress('left', true);
        mobileKeys.left = true;
      });
      mobileUp.addEventListener(eventType, (e) => {
        e.preventDefault();
        simulateKeyPress('up', true);
        mobileKeys.up = true;
      });
      mobileRight.addEventListener(eventType, (e) => {
        e.preventDefault();
        simulateKeyPress('right', true);
        mobileKeys.right = true;
      });
      mobileDown.addEventListener(eventType, (e) => {
        e.preventDefault();
        simulateKeyPress('down', true);
        mobileKeys.down = true;
      });
    });

    ['touchend', 'mouseup', 'touchcancel'].forEach(eventType => {
      mobileLeft.addEventListener(eventType, (e) => {
        e.preventDefault();
        simulateKeyPress('left', false);
        mobileKeys.left = false;
      });
      mobileUp.addEventListener(eventType, (e) => {
        e.preventDefault();
        simulateKeyPress('up', false);
        mobileKeys.up = false;
      });
      mobileRight.addEventListener(eventType, (e) => {
        e.preventDefault();
        simulateKeyPress('right', false);
        mobileKeys.right = false;
      });
      mobileDown.addEventListener(eventType, (e) => {
        e.preventDefault();
        simulateKeyPress('down', false);
        mobileKeys.down = false;
      });
    });

    // Event listeners
    loginBtn.addEventListener('click', loginWithSpotify);
    skipBtn.addEventListener('click', startGame);
    playBtn.addEventListener('click', playTestTrack);
    pauseBtn.addEventListener('click', pauseTrack);
    resumeBtn.addEventListener('click', resumeTrack);
    volumeBtn.addEventListener('click', testVolume);
    logoutBtn.addEventListener('click', logout);
    
    // Clear all cookies and storage on page load
    function clearAllData() {
      // Clear localStorage
      localStorage.clear();
      
      // Clear sessionStorage  
      sessionStorage.clear();
      
      // Clear all cookies
      document.cookie.split(";").forEach(function(c) { 
        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
      });
      
      updateStatus('üßπ Cleared all data');
    }

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      // Always clear data on page load
      clearAllData();
      
      if (window.location.search.includes('code=')) {
        handleCallback();
        return;
      }
      
      // No need to check for saved token since we just cleared everything
    });
    
    // Spotify SDK ready callback (must be in global scope)
    window.onSpotifyWebPlaybackSDKReady = () => {
      updateStatus('üéµ SDK ready');
      if (accessToken) {
        initializeSpotifyPlayer();
      }
    };
  </script>
</body>
</html>